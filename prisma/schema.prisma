generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters", "multiSchema"]
}

datasource db {
  provider = "postgresql"
  schemas  = ["inventa_clinical_app"]
}

model User {
  id                    String                 @id @default(uuid())
  email                 String                 @unique
  username              String?                @unique
  rut                   String?                @unique
  passwordHash          String                 @map("password_hash")
  fullName              String                 @map("full_name")
  role                  Role                   @default(PROFESSIONAL)
  createdAt             DateTime               @default(now()) @map("created_at")
  updatedAt             DateTime               @updatedAt @map("updated_at")
  isActive              Boolean                @default(true) @map("is_active")
  phone                 String?
  mustChangePassword    Boolean                @default(false) @map("must_change_password")
  appointments          Appointment[]
  records               ClinicalRecord[]
  templates             Template[]
  medicalVisits         MedicalVisit[]
  schedules             ProfessionalSchedule[]
  professional          Professional?
  processedTransactions Transaction[]          @relation("TransactionAuthor")
  doctorTransactions    Transaction[]          @relation("TransactionDoctor")
  closes                CashClose[]            @relation("Closer")
  messages              ConversationMessage[]

  @@map("users")
  @@schema("inventa_clinical_app")
}

model Professional {
  id                 String   @id @default(uuid())
  userId             String   @unique @map("user_id")
  firstName          String   @map("first_name")
  lastName           String   @map("last_name")
  specialty          String
  registrationNumber String   @map("registration_number")
  email              String
  phone              String?
  color              String
  status             String   @default("active")
  workingHours       Json?    @map("working_hours")
  integrations       Json?
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")
  isActive           Boolean  @default(true) @map("is_active")
  gender             String?
  prefix             String?
  user               User     @relation(fields: [userId], references: [id])

  @@map("professionals")
  @@schema("inventa_clinical_app")
}

model Branch {
  id            String         @id @default(uuid())
  name          String
  address       String
  city          String
  phone         String
  email         String?
  status        String         @default("active")
  exhibitColor  String         @map("exhibit_color")
  roomsCount    Int            @default(0) @map("rooms_count")
  latitude      Float?
  longitude     Float?
  isMain        Boolean        @default(false) @map("is_main")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  appointments  Appointment[]
  medicalVisits MedicalVisit[]
  patients      Patient[]
  cashCloses    CashClose[]

  @@map("branches")
  @@schema("inventa_clinical_app")
}

model Patient {
  id              String           @id @default(uuid())
  firstName       String           @map("first_name")
  lastName        String           @map("last_name")
  identifier      String           @unique
  email           String?
  phone           String?
  lid             String?          @unique // WhatsApp LID for precise matching
  birthDate       DateTime?        @map("birth_date")
  address         String?
  insuranceId     String?          @map("insurance_id")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  branchId        String?          @map("branch_id")
  gender          String?
  medicalHistory  Json?            @map("medical_history")
  appointments    Appointment[]
  clinicalRecords ClinicalRecord[]
  conversations   Conversation[]
  tags            PatientTag[]
  branch          Branch?          @relation(fields: [branchId], references: [id])
  insurance       Insurance?       @relation(fields: [insuranceId], references: [id])
  prescriptions   Prescription[]
  transactions    Transaction[]

  @@map("patients")
  @@schema("inventa_clinical_app")
}

model Service {
  id               String            @id @default(uuid())
  code             String            @unique
  name             String
  description      String?
  category         String
  price            Decimal           @db.Decimal(10, 2)
  durationMinutes  Int               @map("duration_minutes")
  status           String            @default("active")
  appointments     Appointment[]
  tariffs          Tariff[]
  transactionItems TransactionItem[]

  @@map("services")
  @@schema("inventa_clinical_app")
}

model Insurance {
  id           String    @id @default(uuid())
  name         String
  ruc          String?
  contactName  String?   @map("contact_name")
  contactEmail String?   @map("contact_email")
  contactPhone String?   @map("contact_phone")
  coverageType String    @map("coverage_type")
  status       String    @default("active")
  requiresAuth Boolean   @default(false) @map("requires_auth")
  patients     Patient[]
  tariffs      Tariff[]

  @@map("insurances")
  @@schema("inventa_clinical_app")
}

model Tariff {
  id           String    @id @default(uuid())
  insuranceId  String    @map("insurance_id")
  serviceId    String    @map("service_id")
  coverageType String    @map("coverage_type")
  value        Decimal   @db.Decimal(10, 2)
  insurance    Insurance @relation(fields: [insuranceId], references: [id])
  service      Service   @relation(fields: [serviceId], references: [id])

  @@unique([insuranceId, serviceId])
  @@map("tariffs")
  @@schema("inventa_clinical_app")
}

model Appointment {
  id                 String                @id @default(uuid())
  patientId          String                @map("patient_id")
  doctorId           String?               @map("doctor_id")
  date               DateTime
  duration           Int
  type               AppointmentType
  status             AppointmentStatus     @default(SCHEDULED)
  paymentStatus      PaymentStatus         @default(PENDING) @map("payment_status")
  reason             String?
  notes              String?
  createdAt          DateTime              @default(now()) @map("created_at")
  updatedAt          DateTime              @updatedAt @map("updated_at")
  branchId           String?               @map("branch_id")
  endDate            DateTime?             @map("end_date")
  googleEventId      String?               @map("google_event_id")
  outlookEventId     String?               @map("outlook_event_id")
  serviceId          String?               @map("service_id")
  externalId         String?               @map("external_id")
  legacy_tipoReserva String?               @map("legacy_tipo_reserva")
  secretaryNote      String?               @map("secretary_note")
  reminders          AppointmentReminder[]
  branch             Branch?               @relation(fields: [branchId], references: [id])
  doctor             User?                 @relation(fields: [doctorId], references: [id])
  patient            Patient               @relation(fields: [patientId], references: [id])
  service            Service?              @relation(fields: [serviceId], references: [id])
  npsResponse        NpsResponse?

  @@map("appointments")
  @@schema("inventa_clinical_app")
}

model AppointmentReminder {
  id               String      @id @default(uuid())
  appointmentId    String      @map("appointment_id")
  sentAt           DateTime?   @map("sent_at")
  status           String      @default("pending")
  twilioMessageSid String?     @map("twilio_message_sid")
  errorMessage     String?     @map("error_message")
  retryCount       Int         @default(0) @map("retry_count")
  patientResponse  String?     @map("patient_response")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")
  appointment      Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@map("appointment_reminders")
  @@schema("inventa_clinical_app")
}

model NotificationLog {
  id            String    @id @default(uuid())
  appointmentId String    @map("appointment_id")
  type          String
  channel       String    @default("WHATSAPP")
  status        String
  sentAt        DateTime? @map("sent_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  @@map("notification_logs")
  @@schema("inventa_clinical_app")
}

model ProfessionalSchedule {
  id             String  @id @default(uuid())
  professionalId String  @map("professional_id")
  dayOfWeek      Int
  startTime      String
  endTime        String
  isActive       Boolean @default(true)
  professional   User    @relation(fields: [professionalId], references: [id])

  @@map("professional_schedules")
  @@schema("inventa_clinical_app")
}

model ClinicalRecord {
  id            String         @id @default(uuid())
  patientId     String         @map("patient_id")
  date          DateTime       @default(now())
  doctorId      String?        @map("doctor_id")
  content       Json
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  doctor        User?          @relation(fields: [doctorId], references: [id])
  patient       Patient        @relation(fields: [patientId], references: [id])
  prescriptions Prescription[]

  vitalSigns Json? @map("vital_signs")

  @@map("clinical_records")
  @@schema("inventa_clinical_app")
}

model Prescription {
  id               String          @id @default(uuid())
  patientId        String          @map("patient_id")
  clinicalRecordId String?         @map("clinical_record_id")
  medications      Json
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")
  clinicalRecord   ClinicalRecord? @relation(fields: [clinicalRecordId], references: [id])
  patient          Patient         @relation(fields: [patientId], references: [id])

  @@map("prescriptions")
  @@schema("inventa_clinical_app")
}

model Tag {
  id       String       @id @default(uuid())
  name     String       @unique
  color    String
  patients PatientTag[]

  @@map("tags")
  @@schema("inventa_clinical_app")
}

model PatientTag {
  patientId String  @map("patient_id")
  tagId     String  @map("tag_id")
  patient   Patient @relation(fields: [patientId], references: [id])
  tag       Tag     @relation(fields: [tagId], references: [id])

  @@id([patientId, tagId])
  @@map("patient_tags")
  @@schema("inventa_clinical_app")
}

model Template {
  id          String   @id @default(uuid())
  title       String
  description String?
  content     String
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  isActive    Boolean  @default(true) @map("is_active")
  user        User     @relation(fields: [createdBy], references: [id])

  @@map("clinical_templates")
  @@schema("inventa_clinical_app")
}

model SystemSetting {
  id          String  @id @default(uuid())
  key         String  @unique
  value       Json
  description String?

  @@map("system_settings")
  @@schema("inventa_clinical_app")
}

model MedicationCatalog {
  id          String   @id @default(uuid())
  name        String   @unique
  defaultDose String?  @map("default_dose")
  category    String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("medication_catalog")
  @@schema("inventa_clinical_app")
}

model Transaction {
  id                String            @id @default(uuid())
  patientId         String            @map("patient_id")
  authorId          String?           @map("author_id")
  type              TransactionType
  status            TransactionStatus @default(COMPLETED)
  paymentMethod     PaymentMethod     @map("payment_method")
  paymentCode       String?           @map("payment_code")
  paymentReceiptUrl String?           @map("payment_receipt_url")
  billingRuc        String?           @map("billing_ruc")
  billingName       String?           @map("billing_name")
  billingAddress    String?           @map("billing_address")
  subtotal          Decimal           @db.Decimal(10, 2)
  savings           Decimal           @default(0) @db.Decimal(10, 2)
  total             Decimal           @db.Decimal(10, 2)
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  doctorId          String?           @map("doctor_id")
  exoneratedAmount  Decimal           @default(0) @map("exonerated_amount") @db.Decimal(10, 2)
  observation       String?           @map("observation")
  items             TransactionItem[]
  author            User?             @relation("TransactionAuthor", fields: [authorId], references: [id])
  doctor            User?             @relation("TransactionDoctor", fields: [doctorId], references: [id])
  patient           Patient           @relation(fields: [patientId], references: [id])

  @@map("transactions")
  @@schema("inventa_clinical_app")
}

model TransactionItem {
  id            String      @id @default(uuid())
  transactionId String      @map("transaction_id")
  serviceId     String?     @map("service_id")
  customDescription String? @map("custom_description")
  quantity      Int         @default(1)
  unitPrice     Decimal     @map("unit_price") @db.Decimal(10, 2)
  coverage      Decimal     @default(0) @db.Decimal(10, 2)
  copay         Decimal     @db.Decimal(10, 2)
  service       Service?    @relation(fields: [serviceId], references: [id])
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("transaction_items")
  @@schema("inventa_clinical_app")
}

model MedicalVisit {
  id             String      @id @default(uuid())
  visitorName    String      @map("visitor_name")
  laboratory     String
  branchId       String      @map("branch_id")
  professionalId String      @map("professional_id")
  notes          String?
  status         VisitStatus @default(WAITING)
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  branch         Branch      @relation(fields: [branchId], references: [id])
  professional   User        @relation(fields: [professionalId], references: [id])

  @@index([branchId])
  @@index([professionalId])
  @@index([status])
  @@index([createdAt])
  @@map("medical_visits")
  @@schema("inventa_clinical_app")
}

model Conversation {
  id            String                @id @default(uuid())
  patientId     String                @map("patient_id")
  channel       String                @default("whatsapp")
  status        String                @default("open")
  unreadCount   Int                   @default(0) @map("unread_count")
  lastMessageAt DateTime?             @map("last_message_at")
  createdAt     DateTime              @default(now()) @map("created_at")
  updatedAt     DateTime              @updatedAt @map("updated_at")
  messages      ConversationMessage[]
  tags          ConversationTag[]
  patient       Patient               @relation(fields: [patientId], references: [id])

  @@map("conversations")
  @@schema("inventa_clinical_app")
}

model ConversationMessage {
  id             String       @id @default(uuid())
  conversationId String       @map("conversation_id")
  content        String
  provider       String       @default("twilio") // "twilio" | "baileys"
  fromNumber     String?      @map("from_number")
  toNumber       String?      @map("to_number")
  type           String       @default("text")
  sender         String
  status         String       @default("sent")
  mediaUrl       String?      @map("media_url")
  mediaType      String?      @map("media_type")
  mediaSize      Int?         @map("media_size")
  externalId     String?      @map("external_id")
  externalUrl    String?      @map("external_url")
  sentAt         DateTime     @default(now()) @map("sent_at")
  userId         String?      @map("user_id")
  user           User?        @relation(fields: [userId], references: [id])
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("conversation_messages")
  @@schema("inventa_clinical_app")
}

model ConversationTag {
  id             String       @id @default(uuid())
  conversationId String       @map("conversation_id")
  tag            String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("conversation_tags")
  @@schema("inventa_clinical_app")
}

model AutomationCampaign {
  id          String   @id @default(uuid())
  key         String   @unique
  name        String
  description String?
  isEnabled   Boolean  @default(false) @map("is_enabled")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("automation_campaigns")
  @@schema("inventa_clinical_app")
}

model NpsResponse {
  id                String      @id @default(uuid())
  appointmentId     String      @unique @map("appointment_id")
  patientPhone      String      @map("patient_phone")
  score             Int?
  comment           String?
  status            String      @default("PENDING_SCORE")
  expiresAt         DateTime?   @map("expires_at")
  sentAt            DateTime    @default(now()) @map("sent_at")
  scoreReceivedAt   DateTime?   @map("score_received_at")
  commentReceivedAt DateTime?   @map("comment_received_at")
  appointment       Appointment @relation(fields: [appointmentId], references: [id])

  @@index([patientPhone, status])
  @@map("nps_responses")
  @@schema("inventa_clinical_app")
}

enum Role {
  ADMIN
  PROFESSIONAL
  SECRETARY
  DEVELOPER

  @@schema("inventa_clinical_app")
}

enum AppointmentType {
  CONSULTATION
  FOLLOW_UP
  PROCEDURE

  @@schema("inventa_clinical_app")
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  ARRIVED
  COMPLETED
  CANCELLED
  NO_SHOW
  IN_PROGRESS
  BILLED

  @@schema("inventa_clinical_app")
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIAL
  REFUNDED

  @@schema("inventa_clinical_app")
}

enum TransactionType {
  TICKET
  INVOICE

  @@schema("inventa_clinical_app")
}

enum PaymentMethod {
  CASH
  CARD
  INSURANCE

  @@schema("inventa_clinical_app")
}

enum TransactionStatus {
  COMPLETED
  VOIDED

  @@schema("inventa_clinical_app")
}



enum VisitStatus {
  WAITING
  IN_PROGRESS
  COMPLETED
  CANCELLED

  @@schema("inventa_clinical_app")
}

model CashClose {
  id              String   @id @default(uuid())
  date            DateTime // The day being closed (e.g. 2026-01-20 00:00:00)
  closedAt        DateTime @default(now()) @map("closed_at")
  closedBy        String   @map("closed_by") // User ID of the cashier/person initializing
  
  branchId        String?  @map("branch_id")
  
  // Financial Snapshot
  totalCash       Decimal  @default(0) @map("total_cash") @db.Decimal(10, 2)
  totalCard       Decimal  @default(0) @map("total_card") @db.Decimal(10, 2)
  totalInsurance  Decimal  @default(0) @map("total_insurance") @db.Decimal(10, 2)
  totalAmount     Decimal  @default(0) @map("total_amount") @db.Decimal(10, 2)
  
  // Signatures
  signatures      Json     @default("[]") 
  // Structure: { role: string, userId: string, name: string, timestamp: string, note: string }[]

  status          String   @default("OPEN") // OPEN, CLOSED, VERIFIED

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  branch          Branch?  @relation(fields: [branchId], references: [id])
  closer          User     @relation("Closer", fields: [closedBy], references: [id])

  @@map("cash_closes")
  @@schema("inventa_clinical_app")
}
