generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters", "multiSchema"]
}

datasource db {
  provider = "postgresql"
  schemas  = ["inventa_clinical_app"]
}

model User {
  id                    String                 @id @default(uuid())
  email                 String                 @unique
  username              String?                @unique
  rut                   String?                @unique
  passwordHash          String                 @map("password_hash")
  fullName              String                 @map("full_name")
  role                  Role                   @default(PROFESSIONAL)
  createdAt             DateTime               @default(now()) @map("created_at")
  updatedAt             DateTime               @updatedAt @map("updated_at")
  isActive              Boolean                @default(true) @map("is_active")
  phone                 String?
  mustChangePassword    Boolean                @default(false) @map("must_change_password")
  appointments          Appointment[]
  records               ClinicalRecord[]
  templates             Template[]
  schedules             ProfessionalSchedule[]
  professional          Professional?
  processedTransactions Transaction[]          @relation("TransactionAuthor")
  doctorTransactions    Transaction[]          @relation("TransactionDoctor")
  medicalVisits         MedicalVisit[]

  @@map("users")
  @@schema("inventa_clinical_app")
}

model Professional {
  id                 String   @id @default(uuid())
  userId             String   @unique @map("user_id")
  firstName          String   @map("first_name")
  lastName           String   @map("last_name")
  specialty          String
  registrationNumber String   @map("registration_number")
  email              String
  phone              String?
  color              String
  status             String   @default("active")
  workingHours       Json?    @map("working_hours")
  integrations       Json?
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")
  isActive           Boolean  @default(true) @map("is_active")
  gender             String? // 'M' | 'F' | 'Other'
  prefix             String? // 'el Dr.' | 'la Dra.' | 'el Odontólogo' | 'la Odontóloga'
  user               User     @relation(fields: [userId], references: [id])

  @@map("professionals")
  @@schema("inventa_clinical_app")
}

model Branch {
  id            String         @id @default(uuid())
  name          String
  address       String
  city          String
  phone         String
  email         String?
  status        String         @default("active")
  exhibitColor  String         @map("exhibit_color")
  roomsCount    Int            @default(0) @map("rooms_count")
  latitude      Float?
  longitude     Float?
  isMain        Boolean        @default(false) @map("is_main")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  appointments  Appointment[]
  patients      Patient[]
  medicalVisits MedicalVisit[]

  @@map("branches")
  @@schema("inventa_clinical_app")
}

model Patient {
  id              String           @id @default(uuid())
  firstName       String           @map("first_name")
  lastName        String           @map("last_name")
  identifier      String           @unique
  email           String?
  phone           String?
  birthDate       DateTime?        @map("birth_date")
  address         String?
  insuranceId     String?          @map("insurance_id")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  branchId        String?          @map("branch_id")
  gender          String?
  medicalHistory  Json?            @map("medical_history")
  appointments    Appointment[]
  clinicalRecords ClinicalRecord[]
  tags            PatientTag[]
  branch          Branch?          @relation(fields: [branchId], references: [id])
  insurance       Insurance?       @relation(fields: [insuranceId], references: [id])
  prescriptions   Prescription[]
  transactions    Transaction[]
  conversations   Conversation[]

  @@map("patients")
  @@schema("inventa_clinical_app")
}

model Service {
  id               String            @id @default(uuid())
  code             String            @unique
  name             String
  description      String?
  category         String
  price            Decimal           @db.Decimal(10, 2)
  durationMinutes  Int               @map("duration_minutes")
  status           String            @default("active")
  appointments     Appointment[]
  tariffs          Tariff[]
  transactionItems TransactionItem[]

  @@map("services")
  @@schema("inventa_clinical_app")
}

model Insurance {
  id           String    @id @default(uuid())
  name         String
  ruc          String?
  contactName  String?   @map("contact_name")
  contactEmail String?   @map("contact_email")
  contactPhone String?   @map("contact_phone")
  coverageType String    @map("coverage_type")
  status       String    @default("active")
  requiresAuth Boolean   @default(false) @map("requires_auth")
  patients     Patient[]
  tariffs      Tariff[]

  @@map("insurances")
  @@schema("inventa_clinical_app")
}

model Tariff {
  id           String    @id @default(uuid())
  insuranceId  String    @map("insurance_id")
  serviceId    String    @map("service_id")
  coverageType String    @map("coverage_type")
  value        Decimal   @db.Decimal(10, 2)
  insurance    Insurance @relation(fields: [insuranceId], references: [id])
  service      Service   @relation(fields: [serviceId], references: [id])

  @@unique([insuranceId, serviceId])
  @@map("tariffs")
  @@schema("inventa_clinical_app")
}

model Appointment {
  id                 String                @id @default(uuid())
  patientId          String                @map("patient_id")
  doctorId           String?               @map("doctor_id")
  date               DateTime
  duration           Int
  type               AppointmentType
  status             AppointmentStatus     @default(SCHEDULED)
  reason             String?
  notes              String?
  createdAt          DateTime              @default(now()) @map("created_at")
  updatedAt          DateTime              @updatedAt @map("updated_at")
  branchId           String?               @map("branch_id")
  endDate            DateTime?             @map("end_date")
  googleEventId      String?               @map("google_event_id")
  outlookEventId     String?               @map("outlook_event_id")
  serviceId          String?               @map("service_id")
  externalId         String?               @map("external_id")
  legacy_tipoReserva String?               @map("legacy_tipo_reserva")
  secretaryNote      String?               @map("secretary_note")
  branch             Branch?               @relation(fields: [branchId], references: [id])
  doctor             User?                 @relation(fields: [doctorId], references: [id])
  patient            Patient               @relation(fields: [patientId], references: [id])
  service            Service?              @relation(fields: [serviceId], references: [id])
  reminders          AppointmentReminder[]
  npsResponse        NpsResponse?

  @@map("appointments")
  @@schema("inventa_clinical_app")
}

model AppointmentReminder {
  id               String    @id @default(uuid())
  appointmentId    String    @map("appointment_id")
  sentAt           DateTime? @map("sent_at")
  status           String    @default("pending") // 'pending' | 'sent' | 'failed' | 'delivered' | 'read'
  twilioMessageSid String?   @map("twilio_message_sid")
  errorMessage     String?   @map("error_message") @db.Text
  retryCount       Int       @default(0) @map("retry_count")
  patientResponse  String?   @map("patient_response") // 'confirmed' | 'cancelled' | 'rescheduled' | null
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@map("appointment_reminders")
  @@schema("inventa_clinical_app")
}

model NotificationLog {
  id            String    @id @default(uuid())
  appointmentId String    @map("appointment_id")
  type          String
  channel       String    @default("WHATSAPP")
  status        String
  sentAt        DateTime? @map("sent_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  @@map("notification_logs")
  @@schema("inventa_clinical_app")
}

model ProfessionalSchedule {
  id             String  @id @default(uuid())
  professionalId String  @map("professional_id")
  dayOfWeek      Int
  startTime      String
  endTime        String
  isActive       Boolean @default(true)
  professional   User    @relation(fields: [professionalId], references: [id])

  @@map("professional_schedules")
  @@schema("inventa_clinical_app")
}

model ClinicalRecord {
  id            String         @id @default(uuid())
  patientId     String         @map("patient_id")
  date          DateTime       @default(now())
  doctorId      String?        @map("doctor_id")
  content       Json
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  doctor        User?          @relation(fields: [doctorId], references: [id])
  patient       Patient        @relation(fields: [patientId], references: [id])
  prescriptions Prescription[]

  vitalSigns Json? @map("vital_signs")

  @@map("clinical_records")
  @@schema("inventa_clinical_app")
}

model Prescription {
  id               String          @id @default(uuid())
  patientId        String          @map("patient_id")
  clinicalRecordId String?         @map("clinical_record_id")
  medications      Json
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")
  clinicalRecord   ClinicalRecord? @relation(fields: [clinicalRecordId], references: [id])
  patient          Patient         @relation(fields: [patientId], references: [id])

  @@map("prescriptions")
  @@schema("inventa_clinical_app")
}

model Tag {
  id       String       @id @default(uuid())
  name     String       @unique
  color    String
  patients PatientTag[]

  @@map("tags")
  @@schema("inventa_clinical_app")
}

model PatientTag {
  patientId String  @map("patient_id")
  tagId     String  @map("tag_id")
  patient   Patient @relation(fields: [patientId], references: [id])
  tag       Tag     @relation(fields: [tagId], references: [id])

  @@id([patientId, tagId])
  @@map("patient_tags")
  @@schema("inventa_clinical_app")
}

model Template {
  id          String   @id @default(uuid())
  title       String
  description String?
  content     String
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  isActive    Boolean  @default(true) @map("is_active")
  user        User     @relation(fields: [createdBy], references: [id])

  @@map("clinical_templates")
  @@schema("inventa_clinical_app")
}

model SystemSetting {
  id          String  @id @default(uuid())
  key         String  @unique
  value       Json
  description String?

  @@map("system_settings")
  @@schema("inventa_clinical_app")
}

model MedicationCatalog {
  id          String   @id @default(uuid())
  name        String   @unique
  defaultDose String?  @map("default_dose")
  category    String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("medication_catalog")
  @@schema("inventa_clinical_app")
}

model Transaction {
  id                String            @id @default(uuid())
  patientId         String            @map("patient_id")
  authorId          String?           @map("author_id")
  type              TransactionType
  status            TransactionStatus @default(COMPLETED)
  paymentMethod     PaymentMethod     @map("payment_method")
  paymentCode       String?           @map("payment_code")
  paymentReceiptUrl String?           @map("payment_receipt_url")
  billingRuc        String?           @map("billing_ruc")
  billingName       String?           @map("billing_name")
  billingAddress    String?           @map("billing_address")
  observation       String?           @map("observation") // Motivo de exoneración
  subtotal          Decimal           @db.Decimal(10, 2)
  savings           Decimal           @default(0) @db.Decimal(10, 2) // Cobertura de seguro
  exoneratedAmount  Decimal           @default(0) @map("exonerated_amount") @db.Decimal(10, 2) // Monto exonerado
  total             Decimal           @db.Decimal(10, 2)
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  doctorId          String?           @map("doctor_id")
  items             TransactionItem[]
  author            User?             @relation("TransactionAuthor", fields: [authorId], references: [id])
  doctor            User?             @relation("TransactionDoctor", fields: [doctorId], references: [id])
  patient           Patient           @relation(fields: [patientId], references: [id])

  @@map("transactions")
  @@schema("inventa_clinical_app")
}

model TransactionItem {
  id            String      @id @default(uuid())
  transactionId String      @map("transaction_id")
  serviceId     String      @map("service_id")
  quantity      Int         @default(1)
  unitPrice     Decimal     @map("unit_price") @db.Decimal(10, 2)
  coverage      Decimal     @default(0) @db.Decimal(10, 2)
  copay         Decimal     @db.Decimal(10, 2)
  service       Service     @relation(fields: [serviceId], references: [id])
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("transaction_items")
  @@schema("inventa_clinical_app")
}

enum Role {
  ADMIN
  PROFESSIONAL
  SECRETARY
  DEVELOPER

  @@schema("inventa_clinical_app")
}

enum AppointmentType {
  CONSULTATION
  FOLLOW_UP
  PROCEDURE

  @@schema("inventa_clinical_app")
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
  IN_PROGRESS
  BILLED

  @@schema("inventa_clinical_app")
}

enum TransactionType {
  TICKET
  INVOICE

  @@schema("inventa_clinical_app")
}

enum PaymentMethod {
  CASH
  CARD
  INSURANCE

  @@schema("inventa_clinical_app")
}

enum TransactionStatus {
  COMPLETED
  VOIDED

  @@schema("inventa_clinical_app")
}

model MedicalVisit {
  id             String      @id @default(uuid())
  visitorName    String      @map("visitor_name")
  laboratory     String
  branchId       String      @map("branch_id")
  professionalId String      @map("professional_id")
  notes          String?     @db.Text
  status         VisitStatus @default(WAITING)
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  branch         Branch      @relation(fields: [branchId], references: [id])
  professional   User        @relation(fields: [professionalId], references: [id])

  @@index([branchId])
  @@index([professionalId])
  @@index([status])
  @@index([createdAt])
  @@map("medical_visits")
  @@schema("inventa_clinical_app")
}

enum VisitStatus {
  WAITING
  IN_PROGRESS
  COMPLETED
  CANCELLED

  @@schema("inventa_clinical_app")
}

model Conversation {
  id            String    @id @default(uuid())
  patientId     String    @map("patient_id")
  channel       String    @default("whatsapp") // 'whatsapp' | 'instagram' | 'email'
  status        String    @default("open") // 'open' | 'closed' | 'archived'
  unreadCount   Int       @default(0) @map("unread_count")
  lastMessageAt DateTime? @map("last_message_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  patient  Patient               @relation(fields: [patientId], references: [id])
  messages ConversationMessage[]
  tags     ConversationTag[]

  @@map("conversations")
  @@schema("inventa_clinical_app")
}

model ConversationMessage {
  id             String @id @default(uuid())
  conversationId String @map("conversation_id")
  content        String @db.Text
  type           String @default("text") // 'text' | 'image' | 'audio' | 'video' | 'document'
  sender         String // 'clinic' | 'patient'
  status         String @default("sent") // 'sending' | 'sent' | 'delivered' | 'read'

  // Multimedia fields
  mediaUrl    String? @map("media_url") // Local path: /uploads/messages/...
  mediaType   String? @map("media_type") // MIME type: image/jpeg, audio/ogg
  mediaSize   Int?    @map("media_size") // File size in bytes
  externalId  String? @map("external_id") // Twilio Message SID
  externalUrl String? @map("external_url") // Original Twilio URL (backup)

  sentAt       DateTime     @default(now()) @map("sent_at")
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("conversation_messages")
  @@schema("inventa_clinical_app")
}

model ConversationTag {
  id             String @id @default(uuid())
  conversationId String @map("conversation_id")
  tag            String

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("conversation_tags")
  @@schema("inventa_clinical_app")
}

model AutomationCampaign {
  id          String   @id @default(uuid())
  key         String   @unique // 'appointment_reminders' | 'birthday_greetings'
  name        String
  description String?
  isEnabled   Boolean  @default(false) @map("is_enabled")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("automation_campaigns")
  @@schema("inventa_clinical_app")
}

model NpsResponse {
  id               String    @id @default(uuid())
  appointmentId    String    @map("appointment_id")
  patientPhone     String    @map("patient_phone")
  score            Int?      // 1 (Mala) | 3 (Regular) | 5 (Excelente)
  comment          String?   @db.Text
  status           String    @default("PENDING_SCORE") // PENDING_SCORE | PENDING_COMMENT | COMPLETED
  expiresAt        DateTime? @map("expires_at")
  sentAt           DateTime  @default(now()) @map("sent_at")
  scoreReceivedAt  DateTime? @map("score_received_at")
  commentReceivedAt DateTime? @map("comment_received_at")
  
  appointment      Appointment @relation(fields: [appointmentId], references: [id])
  
  @@unique([appointmentId])
  @@index([patientPhone, status])
  @@map("nps_responses")
  @@schema("inventa_clinical_app")
}
